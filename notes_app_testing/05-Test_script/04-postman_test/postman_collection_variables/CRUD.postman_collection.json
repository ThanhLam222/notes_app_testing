{
	"info": {
		"_postman_id": "561c1204-3120-4108-a907-e8e39b539b4c",
		"name": "2. CRUD",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
		"_exporter_id": "46966736",
		"_collection_link": "https://spaceflight-technologist-5034671-5912520.postman.co/workspace/Note-app-testing~594e2783-9472-4812-a12d-398cfffb1e8f/collection/46966736-561c1204-3120-4108-a907-e8e39b539b4c?action=share&source=collection_link&creator=46966736"
	},
	"item": [
		{
			"name": "Sign in for CRUD collection",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"const cheerio = require('cheerio');\r",
							"const $ = cheerio.load(pm.response.text());\r",
							"\r",
							"pm.test(\"Should return 200 OK with All notes page\", () => {\r",
							"    // Check status and headers\r",
							"    pm.response.to.have.status(200);\r",
							"    pm.expect(pm.response.headers.get('Content-Type')).to.include('text/html');\r",
							"    pm.expect(pm.cookies.get('sessionid')).to.not.be.null;\r",
							"\r",
							"    // Check body\r",
							"    const allNotes = $('div.col-md-3')\r",
							"    const countNotes = allNotes.length;\r",
							"    if(countNotes > 0) {\r",
							"        allNotes.each((i, el) => {\r",
							"        pm.expect($(el).find('h4.card-title').text().trim()).to.not.be.empty;\r",
							"        pm.expect($(el).find('p').text().trim()).to.not.be.empty;\r",
							"        });\r",
							"    }\r",
							"    else {\r",
							"        pm.expect($('p.lead').length).to.equal(1);\r",
							"        pm.expect($('p.lead').text().trim()).to.equal(\"There are no Notes yet.\");\r",
							"    }\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [],
				"body": {
					"mode": "urlencoded",
					"urlencoded": [
						{
							"key": "email",
							"value": "admin@localhost",
							"type": "text"
						},
						{
							"key": "password",
							"value": "adminpassword",
							"type": "text"
						}
					]
				},
				"url": {
					"raw": "{{baseUrl}}auth/signin",
					"host": [
						"{{baseUrl}}auth"
					],
					"path": [
						"signin"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get all note",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"if(!pm.iterationData.get(\"allNotes\")) {\r",
							"    pm.execution.skipRequest();\r",
							"}"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"const cheerio = require('cheerio');\r",
							"const $ = cheerio.load(pm.response.text());\r",
							"\r",
							"const allNotes = $('div.col-md-3');\r",
							"const countNote = allNotes.length;\r",
							"\r",
							"if(!pm.iterationData.get(\"hasNote\")) {\r",
							"    // Because if postman run this case, it means a new round of testing is starting\r",
							"    pm.collectionVariables.set(\"countCreateNote\", 1)\r",
							"    if(countNote > 0) {\r",
							"        pm.collectionVariables.set(\"activeDelete\", \"true\");\r",
							"        const note = allNotes.first();\r",
							"        const title = note.find('h4').text().trim();\r",
							"        const description = note.find('p').text().trim();\r",
							"        const noteID = note.find('a').attr('href').split('/').pop();\r",
							"        pm.collectionVariables.set(\"noteIDActiveDelete\", noteID);\r",
							"        pm.collectionVariables.set(\"titleActiveDelete\", title);\r",
							"        pm.collectionVariables.set(\"descriptionActiveDelete\", description);\r",
							"        // Delete note before test all notes page has no notes\r",
							"        pm.execution.setNextRequest(\"Delete note\");\r",
							"    } else {\r",
							"        pm.collectionVariables.set(\"activeDelete\", \"false\");\r",
							"        pm.test(\"Should returns 200 OK with All notes page when has user is logged-in and has no notes\", () => {\r",
							"            // Check status and headers\r",
							"            pm.response.to.have.status(200);\r",
							"            pm.expect(pm.response.headers.get(\"Content-Type\")).to.include(\"text/html\");\r",
							"            pm.expect(pm.cookies.get('sessionid')).to.not.be.null;\r",
							"\r",
							"            // Check body\r",
							"            pm.expect($('h1').text().trim()).to.equal(\"Hello admin\");\r",
							"            pm.expect($('p.lead').text().trim()).to.equal(\"There are not Notes yet.\");\r",
							"            const atag = $('div.card-body').find('a');\r",
							"            pm.expect(atag.length).to.equal(1);\r",
							"            pm.expect(atag.attr('href')).to.equal(\"/notes/add\");\r",
							"            pm.expect(atag.text().trim()).to.equal(\"Create One!\");\r",
							"        });\r",
							"    }\r",
							"} else {\r",
							"    pm.test(\"Should returns 200 OK with All notes page when has user is logged-in and has notes\", () => {\r",
							"        // Check status and headers\r",
							"        pm.response.to.have.status(200);\r",
							"        pm.expect(pm.response.headers.get(\"Content-Type\")).to.include(\"text/html\");\r",
							"        pm.expect(pm.cookies.get('sessionid')).to.not.be.null;\r",
							"\r",
							"        // Check body\r",
							"        const expectedCount = +pm.collectionVariables.get(\"countCreateNote\") - 1;\r",
							"        pm.expect(allNotes.length).to.equal(expectedCount);\r",
							"        // Check if notes are displayed in descending order of date, and have edit and delete button\r",
							"        let indexNote = expectedCount; // This variables used to get the responding note collectionVariables to test\r",
							"        allNotes.each((i, el) => {\r",
							"            // Check title and description\r",
							"            const noteTitle = $(el).find('h4').text().trim();\r",
							"            const noteDescription = $(el).find('p').text().trim();\r",
							"            pm.expect(noteTitle).to.equal(pm.collectionVariables.get(`title${indexNote}`));\r",
							"            pm.expect(noteDescription).to.equal(pm.collectionVariables.get(`description${indexNote}`));\r",
							"            indexNote -= 1; // Decrease the indexNote to get the next note collectionVariables to test\r",
							"\r",
							"            // Check edit icon\r",
							"            const editHref = $(el).find('h4 > a').attr('href');\r",
							"            pm.expect(editHref).to.equal(1);\r",
							"            pm.expect(editHref).to.match(/^\\/notes\\/edit\\/[a-f\\d]{24}$/);\r",
							"\r",
							"            // Check delete form and button\r",
							"            const deleteForm = $(el).find('form');\r",
							"            pm.expect(deleteForm.length).to.be.greaterThan(0);\r",
							"\r",
							"            const deleteAttr = deleteForm.attr('action');\r",
							"            pm.expect(deleteAttr).to.equal(1);\r",
							"\r",
							"            const deleteButton = deleteForm.find('button');\r",
							"            pm.expect(deleteButton.length).to.be.greaterThan(0);\r",
							"\r",
							"            pm.expect(deleteAttr).to.match(/^\\/notes\\/delete\\/[a-f\\d]{24}\\?_method=DELETE$/);\r",
							"            pm.expect(deleteButton.text().trim()).to.equal(\"Delete\");\r",
							"        });\r",
							"    });\r",
							"}"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [],
				"url": {
					"raw": "{{baseUrl}}notes",
					"host": [
						"{{baseUrl}}notes"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get new note",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"if(!pm.iterationData.get(\"getNewForm\")) {\r",
							"    pm.execution.skipRequest();\r",
							"}"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"const cheerio = require('cheerio');\r",
							"const $ = cheerio.load(pm.response.text());\r",
							"\r",
							"pm.test(\"Should return 200 OK with New note page when logged in\", () => {\r",
							"    // Check status and headers\r",
							"    pm.response.to.have.status(200);\r",
							"    pm.expect(pm.response.headers.get(\"Content-Type\")).to.include(\"text/html\");\r",
							"    pm.expect(pm.cookies.get('sessionid')).to.not.be.null;\r",
							"\r",
							"    // Check body\r",
							"    pm.expect($('h3').text().trim()).to.equal(\"New Note\");\r",
							"\r",
							"    // Check form action\r",
							"    const form = $('form');\r",
							"    pm.expect(form.attr('action')).to.equal('/notes/new-note');\r",
							"    pm.expect(form.attr('method')).to.equal('POST');\r",
							"\r",
							"    // Check form fields\r",
							"    const fieldsForm = $('div.mb-3');\r",
							"    pm.expect(fieldsForm.length).to.equal(2);\r",
							"\r",
							"    const expectedNameFields = [\"Title:\", \"Description:\"]\r",
							"    fieldsForm.each((i, el) => {\r",
							"        pm.expect($(el).find('label').text().trim()).to.equal(expectedNameFields[i]);\r",
							"    });\r",
							"\r",
							"    // Check save button\r",
							"    pm.expect($('form > button').text().trim()).to.equal(\"Save\");\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [],
				"url": {
					"raw": "{{baseUrl}}notes/add",
					"host": [
						"{{baseUrl}}notes"
					],
					"path": [
						"add"
					]
				}
			},
			"response": []
		},
		{
			"name": "Post new note",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"if(!pm.iterationData.get(\"postNewNote\")) {\r",
							"    pm.execution.skipRequest();\r",
							"}"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"const count = +pm.collectionVariables.get(\"countCreateNote\") || 1;\r",
							"const cheerio = require('cheerio');\r",
							"const $ = cheerio.load(pm.response.text());\r",
							"const inputTitle = pm.iterationData.get(\"title\");\r",
							"const inputDescription = pm.iterationData.get(\"description\");\r",
							"\r",
							"pm.test(\"Should return 200 OK and 'Note Added Successfully.' appears after note creation succeeds\", () => {\r",
							"    // Check status and headers\r",
							"    pm.response.to.have.status(200);\r",
							"    pm.expect(pm.response.headers.get(\"Content-Type\")).to.include(\"text/html\");\r",
							"    pm.expect(pm.cookies.get('sessionid')).to.not.be.null;\r",
							"\r",
							"    // Check body\r",
							"    // Check messages\r",
							"    const messages = $('div.alert');\r",
							"    pm.expect(messages.length).to.equal(1);\r",
							"    pm.expect(messages.text().trim()).to.equal(\"Note Added Successfully\");\r",
							"\r",
							"    // Check note details\r",
							"    const allNotes = $('div.col-md-3').toArray();\r",
							"    pm.expect(allNotes.length).to.be.at.least(1);\r",
							"    let found = false;\r",
							"    for(const el of allNotes) {\r",
							"        const noteTitle = $(el).find('h4').text().trim();\r",
							"        const noteDescription = $(el).find('p').text().trim();\r",
							"        if (noteTitle === inputTitle && noteDescription === inputDescription) {\r",
							"            found = true;\r",
							"            break;\r",
							"        }\r",
							"    }\r",
							"    pm.expect(found).to.be.true;\r",
							"});\r",
							"\r",
							"// Save title, description and noteID to use for others test\r",
							"pm.collectionVariables.set(`title${count}`, inputTitle);\r",
							"pm.collectionVariables.set(`description${count}`, inputDescription);\r",
							"const noteID = $(`h4:contains(\"${inputTitle}\")`).find('a')\r",
							"                                                .attr('href')\r",
							"                                                .split('/')\r",
							"                                                .pop();\r",
							"pm.collectionVariables.set(`noteID${count}`, noteID);\r",
							"pm.collectionVariables.set(\"countCreateNote\", count + 1);"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [],
				"body": {
					"mode": "urlencoded",
					"urlencoded": [
						{
							"key": "title",
							"value": "{{title}}",
							"type": "text"
						},
						{
							"key": "description",
							"value": "{{description}}",
							"type": "text"
						}
					]
				},
				"url": {
					"raw": "{{baseUrl}}notes/new-note",
					"host": [
						"{{baseUrl}}notes"
					],
					"path": [
						"new-note"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get edit note",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"if(!pm.iterationData.get(\"editNote\")) {\r",
							"    pm.execution.skipRequest();\r",
							"}\r",
							"\r",
							"pm.variables.set(\"noteID\", pm.collectionVariables.get(\"noteID1\"));"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"const cheerio = require('cheerio');\r",
							"const $ = cheerio.load(pm.response.text());\r",
							"const noteID = pm.variables.get(\"noteID\");\r",
							"\r",
							"pm.test(\"Should return 200 OK with correct note data for owner\", () =>  {\r",
							"    // Check status and headers\r",
							"    pm.response.to.have.status(200);\r",
							"    pm.expect(pm.response.headers.get(\"Content-Type\")).to.include(\"text/html\");\r",
							"    pm.expect(pm.cookies.get('sessionid')).to.not.be.null;\r",
							"\r",
							"    // Check body\r",
							"    pm.expect($('h3').text().trim()).to.equal(\"Edit Note\");\r",
							"\r",
							"    \r",
							"    // Check form action\r",
							"    pm.expect($('form').attr('action')).to.equal(`/notes/edit-note/${noteID}?_method=PUT`);\r",
							"\r",
							"    // Check form fields\r",
							"    const fieldsForm = $('div.mb-3');\r",
							"    pm.expect(fieldsForm.length).to.equal(2);\r",
							"\r",
							"    const expectedNameFields = [\"Title:\", \"Description:\"]\r",
							"    fieldsForm.each((i, el) => {\r",
							"        pm.expect($(el).find('label').text().trim()).to.equal(expectedNameFields[i]);\r",
							"        if (expectedNameFields[i] === \"Title:\") {\r",
							"            pm.expect($(el).find('input').attr('value')).to.equal(pm.collectionVariables.get('title1'));\r",
							"        } else {\r",
							"            pm.expect($(el).find('textarea').text().trim()).to.equal(pm.collectionVariables.get('description1'));\r",
							"        }\r",
							"    // Check save button\r",
							"        pm.expect($('form > button').text().trim()).to.equal('Save');\r",
							"    });\r",
							"});\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [],
				"url": {
					"raw": "{{baseUrl}}notes/edit/{{noteID}}",
					"host": [
						"{{baseUrl}}notes"
					],
					"path": [
						"edit",
						"{{noteID}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Put edit note",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"if(!pm.iterationData.get(\"editNote\")) {\r",
							"    pm.execution.skipRequest();\r",
							"}\r",
							"\r",
							"pm.variables.set(\"noteID\", pm.collectionVariables.get(\"noteID1\"));"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"const cheerio = require('cheerio');\r",
							"const $ = cheerio.load(pm.response.text());\r",
							"const inputTitle = pm.iterationData.get(\"title\");\r",
							"const inputDescription = pm.iterationData.get(\"description\");\r",
							"const noteID = pm.variables.get(\"noteID\");\r",
							"\r",
							"pm.test(\"Should return 200 OK and 'Note Updated Successfully' appears after successful note update\", () => {\r",
							"    // Check status and headers\r",
							"    pm.response.to.have.status(200);\r",
							"    pm.expect(pm.response.headers.get(\"Content-Type\")).to.include(\"text/html\");\r",
							"    pm.expect(pm.cookies.get('sessionid')).to.not.be.null;\r",
							"\r",
							"    // Check body\r",
							"    const updatedNote = $(`div.card-body:has(a[href=\"/notes/edit/${noteID}\"])`);\r",
							"    pm.expect(updatedNote.length).to.be.greaterThan(0);\r",
							"    pm.expect(updatedNote.find('h4').text().trim()).to.equal(inputTitle);\r",
							"    pm.expect(updatedNote.find('p').text().trim()).to.equal(inputDescription);\r",
							"\r",
							"    // Check messages\r",
							"    const messages = $('div.alert');\r",
							"    pm.expect(messages.length).to.equal(1);\r",
							"    pm.expect(messages.text().trim()).to.equal('Note Updated Successfully');\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"request": {
				"method": "PUT",
				"header": [],
				"body": {
					"mode": "urlencoded",
					"urlencoded": [
						{
							"key": "title",
							"value": "{{title}}",
							"type": "text"
						},
						{
							"key": "description",
							"value": "{{description}}",
							"type": "text"
						}
					]
				},
				"url": {
					"raw": "{{baseUrl}}notes/edit-note/{{noteID}}",
					"host": [
						"{{baseUrl}}notes"
					],
					"path": [
						"edit-note",
						"{{noteID}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Delete note",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"if(!pm.iterationData.get(\"deleteNote\")&&!(pm.collectionVariables.get(\"activeDelete\")=== \"true\")) {\r",
							"    pm.execution.skipRequest();\r",
							"}\r",
							"\r",
							"if(pm.collectionVariables.get(\"activeDelete\")) {\r",
							"    // This case used when delete is called from all notes request\r",
							"    pm.variables.set(\"noteID\", pm.collectionVariables.get(\"noteIDActiveDelete\"));\r",
							"} else if(!pm.collectionVariables.get(\"activeDelete\")) {\r",
							"    // This case used when delete is called from delete note request itself\r",
							"    pm.variables.set(\"noteID\", pm.collectionVariables.get(\"noteID1\"));\r",
							"}\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"const cheerio = require(\"cheerio\"); // Load cheerio for HTML parsing\r",
							"const $ = cheerio.load(pm.response.text()); // Load the HTML response into cheerio\r",
							"\r",
							"pm.test(\"Should  return 200 Ok and 'Note Deleted Successfully' appears after successful deletion\", () => {\r",
							"    // Check status and headers\r",
							"    pm.response.to.have.status(200);\r",
							"    pm.expect(pm.response.headers.get(\"Content-Type\")).to.include(\"text/html\");\r",
							"    pm.expect(pm.cookies.get('sessionid')).to.not.be.null;\r",
							"\r",
							"    // Check body\r",
							"    // Check if note is no longer displayed.\r",
							"    const allNotes = $('div.col-md-3').toArray();\r",
							"    const count = allNotes.length;\r",
							"    if (count === 0) {\r",
							"        pm.expect($('p.lead').text().trim()).to.equal(\"There are no Notes yet.\");\r",
							"    } else {\r",
							"        let found = false\r",
							"        for(const el of allNotes) {\r",
							"            const noteHref = $(el).find('h4 > a').attr('href');\r",
							"            const noteID = noteHref.split('/').pop(); // Extract noteID from href\r",
							"            if (noteID === pm.variables.get(\"noteID\")) {\r",
							"                found = true;\r",
							"                break;\r",
							"            }\r",
							"        }\r",
							"        pm.expect(found).to.be.false; // If note is found, it should not be there after deletion\r",
							"    }\r",
							"\r",
							"    // Check messages\r",
							"    const messages = $('div.alert');\r",
							"    pm.expect(messages.length).to.equal(1);\r",
							"    pm.expect(messages.text().trim()).to.equal('Note Deleted Successfully');\r",
							"});\r",
							"\r",
							"// This case used when delete is called from all notes request\r",
							"if(pm.collectionVariables.get(\"activeDelete\") === \"true\") {\r",
							"    pm.execution.setNextRequest(\"Get all note\");\r",
							"}"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"request": {
				"method": "DELETE",
				"header": [],
				"url": {
					"raw": "{{baseUrl}}notes/delete/{{noteID}}",
					"host": [
						"{{baseUrl}}notes"
					],
					"path": [
						"delete",
						"{{noteID}}"
					]
				}
			},
			"response": []
		}
	],
	"variable": [
		{
			"key": "countCreateNote",
			"value": ""
		},
		{
			"key": "activeDelete",
			"value": ""
		},
		{
			"key": "noteIDActiveDelete",
			"value": ""
		},
		{
			"key": "titleActiveDelete",
			"value": ""
		},
		{
			"key": "descriptionActiveDelete",
			"value": ""
		},
		{
			"key": "title1",
			"value": ""
		},
		{
			"key": "description1",
			"value": ""
		},
		{
			"key": "noteID1",
			"value": ""
		},
		{
			"key": "title2",
			"value": ""
		},
		{
			"key": "description2",
			"value": ""
		},
		{
			"key": "noteID2",
			"value": ""
		},
		{
			"key": "title3",
			"value": ""
		},
		{
			"key": "description3",
			"value": ""
		},
		{
			"key": "noteID3",
			"value": ""
		}
	]
}